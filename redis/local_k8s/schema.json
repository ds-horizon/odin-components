{
  "title": "Redis Local K8s (Opstree Operator) Flavour Configuration",
  "type": "object",
  "description": "Configuration schema for Redis deployment on a local Kubernetes cluster (kind/minikube/Docker Desktop) using the Opstree Redis Operator. Mirrors the aws_k8s schema shape but with smaller defaults suited for laptops.",
  "allOf": [
    {
      "oneOf": [
        {
          "properties": {
            "deploymentMode": { "const": "standalone" }
          },
          "not": {
            "anyOf": [
              { "required": ["cluster"] },
              { "required": ["sentinel"] }
            ]
          }
        },
        {
          "properties": {
            "deploymentMode": { "const": "cluster" }
          },
          "required": ["cluster"],
          "not": { "required": ["sentinel"] }
        },
        {
          "properties": {
            "deploymentMode": { "const": "sentinel" }
          },
          "required": ["sentinel"],
          "not": { "required": ["cluster"] }
        }
      ]
    }
  ],
  "properties": {
    "deploymentMode": {
      "type": "string",
      "enum": ["standalone", "cluster", "sentinel"],
      "description": "Redis deployment mode supported by Opstree operator for local clusters. **standalone:** Single Redis instance (1 pod). **cluster:** Horizontal scaling with data sharding across multiple masters with replicas. **sentinel:** Master-replica topology with Sentinel for automatic failover. **Default: `standalone`**.",
      "default": "standalone"
    },
    "cluster": {
      "type": "object",
      "description": "Redis Cluster mode configuration. Only applicable when deploymentMode is 'cluster'. For local clusters you should keep sizes small (e.g. 3 masters × 1 replica).",
      "properties": {
        "clusterSize": {
          "type": "integer",
          "minimum": 3,
          "maximum": 9,
          "description": "Number of master nodes in cluster. Each master handles a portion of the 16,384 hash slots. Minimum 3 required. **Default: `3`**.",
          "default": 3
        },
        "replicasPerMaster": {
          "type": "integer",
          "minimum": 0,
          "maximum": 2,
          "description": "Number of replica nodes per master. Total pods = clusterSize × (1 + replicasPerMaster). For local clusters keep this small (0–1). **Default: `0`**.",
          "default": 0
        }
      },
      "required": ["clusterSize", "replicasPerMaster"]
    },
    "sentinel": {
      "type": "object",
      "description": "Redis Sentinel mode configuration. Only applicable when deploymentMode is 'sentinel'. Provides automatic failover for master-replica topology. Defaults are reduced for local usage.",
      "properties": {
        "replicationSize": {
          "type": "integer",
          "minimum": 2,
          "maximum": 3,
          "description": "Total size of replication group (1 master + N replicas). **Default: `2`** (1 master + 1 replica) for local.",
          "default": 2
        },
        "sentinelSize": {
          "type": "integer",
          "enum": [3],
          "description": "Number of Sentinel instances. For local clusters we default to 3 for proper quorum. **Default: `3`**.",
          "default": 3
        },
        "quorum": {
          "type": "integer",
          "minimum": 2,
          "description": "Number of Sentinels that must agree master is down before initiating failover. **Default: `2`**.",
          "default": 2
        },
        "downAfterMilliseconds": {
          "type": "integer",
          "minimum": 1000,
          "description": "Milliseconds before Sentinel marks an instance as down. **Default: `5000`**.",
          "default": 5000
        },
        "parallelSyncs": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of replicas that can sync with new master in parallel during failover. **Default: `1`**.",
          "default": 1
        },
        "failoverTimeout": {
          "type": "integer",
          "minimum": 1000,
          "description": "Failover timeout in milliseconds. **Default: `10000`**.",
          "default": 10000
        }
      },
      "required": ["replicationSize", "sentinelSize", "quorum"]
    },
    "image": {
      "type": "string",
      "description": "Docker image repository (including registry) for Redis data pods (standalone, cluster, replication) in local clusters. If not set, defaults to `quay.io/opstree/redis`. You can point this to your own registry, e.g. a local kind or minikube registry mirror.",
      "default": "quay.io/opstree/redis"
    },
    "sentinelImage": {
      "type": "string",
      "description": "Docker image repository (including registry) for Redis Sentinel pods in local clusters. If not set, defaults to `quay.io/opstree/redis-sentinel`. You can point this to your own registry, e.g. a local kind or minikube registry mirror.",
      "default": "quay.io/opstree/redis-sentinel"
    },
    "resources": {
      "type": "object",
      "description": "Kubernetes resource requests and limits for Redis pods. Applies to all Redis nodes. Defaults are much smaller than aws_k8s to fit laptops.",
      "properties": {
        "requests": {
          "type": "object",
          "description": "Minimum guaranteed resources.",
          "properties": {
            "cpu": {
              "type": "string",
              "pattern": "^[0-9]+(m|\\.[0-9]+)?$",
              "description": "Minimum CPU guaranteed. **Default: `100m`** for local clusters.",
              "default": "100m"
            },
            "memory": {
              "type": "string",
              "pattern": "^[0-9]+(Mi|Gi)$",
              "description": "Minimum memory guaranteed. **Default: `128Mi`**.",
              "default": "128Mi"
            }
          },
          "required": ["cpu", "memory"]
        },
        "limits": {
          "type": "object",
          "description": "Maximum allowed resources.",
          "properties": {
            "cpu": {
              "type": "string",
              "pattern": "^[0-9]+(m|\\.[0-9]+)?$",
              "description": "Maximum CPU. **Default: `500m`**.",
              "default": "500m"
            },
            "memory": {
              "type": "string",
              "pattern": "^[0-9]+(Mi|Gi)$",
              "description": "Maximum memory. **Default: `512Mi`**.",
              "default": "512Mi"
            }
          },
          "required": ["cpu", "memory"]
        }
      },
      "required": ["requests", "limits"]
    },
    "storage": {
      "type": "object",
      "description": "Persistent storage configuration. For local clusters you may keep this small or use ephemeral storage via the cluster's default StorageClass.",
      "properties": {
        "storageClassName": {
          "type": "string",
          "description": "Kubernetes StorageClass name. For local clusters this might be 'standard' or whatever your local provisioner uses. **Default: `\"\"`** (cluster default).",
          "default": ""
        },
        "storageSize": {
          "type": "string",
          "pattern": "^[0-9]+(Mi|Gi|Ti)$",
          "description": "Size of persistent volume per Redis pod. **Default: `1Gi`** for local.",
          "default": "1Gi"
        },
        "nodeConfStorageSize": {
          "type": "string",
          "pattern": "^[0-9]+(Mi|Gi|Ti)$",
          "description": "Size for cluster node configuration volume (cluster mode). **Default: `256Mi`**.",
          "default": "256Mi"
        }
      },
      "required": ["storageSize"]
    },
    "metrics": {
      "type": "object",
      "description": "Prometheus metrics configuration via Redis Exporter sidecar.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable Redis Exporter sidecar for Prometheus metrics. **Default: `true`**.",
          "default": true
        },
        "redisExporterImage": {
          "type": "string",
          "description": "Docker image (including registry/repository) for the Redis Exporter sidecar in local clusters. Defaults to the public Opstree exporter image. Override this to point at your own registry mirror.",
          "default": "quay.io/opstree/redis-exporter"
        },
        "redisExporterTag": {
          "type": "string",
          "description": "Docker image tag for the Redis Exporter sidecar. **Default: `v1.44.0`**.",
          "default": "v1.44.0"
        },
        "exporterResources": {
          "type": "object",
          "description": "Resource allocation for Redis Exporter sidecar container.",
          "properties": {
            "requests": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "string",
                  "pattern": "^[0-9]+(m|\\.[0-9]+)?$",
                  "description": "Exporter CPU request. **Default: `25m`**.",
                  "default": "25m"
                },
                "memory": {
                  "type": "string",
                  "pattern": "^[0-9]+(Mi|Gi)$",
                  "description": "Exporter memory request. **Default: `32Mi`**.",
                  "default": "32Mi"
                }
              }
            },
            "limits": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "string",
                  "pattern": "^[0-9]+(m|\\.[0-9]+)?$",
                  "description": "Exporter CPU limit. **Default: `100m`**.",
                  "default": "100m"
                },
                "memory": {
                  "type": "string",
                  "pattern": "^[0-9]+(Mi|Gi)$",
                  "description": "Exporter memory limit. **Default: `128Mi`**.",
                  "default": "128Mi"
                }
              }
            }
          }
        }
      }
    },
    "securityContext": {
      "type": "object",
      "description": "Pod security context for running Redis containers with restricted privileges.",
      "properties": {
        "runAsNonRoot": {
          "type": "boolean",
          "description": "Run Redis as non-root user. **Default: `true`**.",
          "default": true
        },
        "runAsUser": {
          "type": "integer",
          "description": "UID to run Redis process. **Default: `1000`**.",
          "default": 1000
        },
        "fsGroup": {
          "type": "integer",
          "description": "GID for volume ownership. **Default: `1000`**.",
          "default": 1000
        }
      }
    },
    "nodeSelector": {
      "type": "object",
      "description": "Kubernetes node selector for constraining Redis pods to specific nodes.",
      "additionalProperties": {
        "type": "string"
      },
      "default": {}
    },
    "tolerations": {
      "type": "array",
      "description": "Pod tolerations for scheduling on tainted nodes. **Default: `[]`**.",
      "items": {
        "type": "object",
        "properties": {
          "key": { "type": "string" },
          "operator": { "type": "string", "enum": ["Equal", "Exists"] },
          "value": { "type": "string" },
          "effect": { "type": "string", "enum": ["NoSchedule", "PreferNoSchedule", "NoExecute"] }
        }
      },
      "default": []
    },
    "podDisruptionBudget": {
      "type": "object",
      "description": "PodDisruptionBudget hints for local clusters.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable PodDisruptionBudget hints. **Default: `false`** for local.",
          "default": false
        },
        "minAvailable": {
          "type": "integer",
          "minimum": 1,
          "description": "Minimum pods that must remain available during disruptions. **Default: `1`**.",
          "default": 1
        }
      }
    },
    "serviceAccount": {
      "type": "string",
      "description": "Kubernetes ServiceAccount name. **Default: `default`**.",
      "default": "default"
    },
    "priorityClassName": {
      "type": "string",
      "description": "PriorityClass name for pod scheduling priority. For local clusters this is typically left empty.",
      "default": ""
    },
    "imagePullPolicy": {
      "type": "string",
      "enum": ["Always", "IfNotPresent", "Never"],
      "description": "Image pull policy. **Default: `IfNotPresent`**.",
      "default": "IfNotPresent"
    }
  },
  "required": ["deploymentMode", "resources", "storage"]
}
