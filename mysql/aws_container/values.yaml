image:
  registry: {{ flavourConfig.imageRegistry }}
  repository: {{ flavourConfig.imageRepository }}
  tag: {{ flavourConfig.imageTag }}

auth:
  username: {{ flavourConfig.username }}
  password: {{ flavourConfig.password }}

global:
  storageClass: {{ flavourConfig.storageClass }}

{% if flavourConfig.readerCount == 0 %}
architecture: standalone
{% else %}
architecture: replication
{% endif %}

{% set serviceAnnotations = componentMetadata.cloudProviderDetails.account.services | selectattr('category', 'eq', 'KUBERNETES') | map(attribute='data') | map(attribute='serviceAnnotations') | list | first %}

primary:
  resources:
    requests:
      memory: {{ flavourConfig.writer.resources.requests.memory }}
      cpu: {{ flavourConfig.writer.resources.requests.cpu }}
      ephemeral-storage: {{ flavourConfig.writer.resources.requests.ephemeralStorage }}
    limits:
      memory: {{ flavourConfig.writer.resources.limits.memory }}
      cpu: {{ flavourConfig.writer.resources.limits.cpu }}
      ephemeral-storage: {{ flavourConfig.writer.resources.limits.ephemeralStorage }}


  {% if flavourConfig.writer.tolerations %}
  tolerations:
    {% for toleration in flavourConfig.writer.tolerations %}
    - key: {{ toleration.key }}
      operator: {{ toleration.operator }}
      {% if toleration.value %}
      value: {{ toleration.value }}
      {% endif %}
      {% if toleration.effect %}
      effect: {{ toleration.effect }}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if flavourConfig.writer.nodeSelector %}
  nodeSelector:
    {% for key, value in flavourConfig.writer.nodeSelector.items() %}
    {{ key }}: {{ value }}
    {% endfor %}
  {% endif %}
  {% if flavourConfig.writer.persistence %}
  persistence:
    enabled: true
    size: {{ flavourConfig.writer.persistence.size }}
    storageClass: {{ flavourConfig.storageClass }}
  {% endif %}

  {% if serviceAnnotations %}
  service:
    annotations:
      {% for key,value in serviceAnnotations.items() %}
      {{ key }}: "{{ value }}"
      {% endfor %}
  {% endif %}


  configuration: |-
    [mysqld]
    server-id=1
    default_authentication_plugin=mysql_native_password
    skip-name-resolve
    explicit_defaults_for_timestamp
    basedir=/opt/bitnami/mysql
    plugin_dir=/opt/bitnami/mysql/lib/plugin
    port=3306
    socket=/opt/bitnami/mysql/tmp/mysql.sock
    datadir=/bitnami/mysql/data
    tmpdir=/opt/bitnami/mysql/tmp
    max_allowed_packet=16M
    bind-address=0.0.0.0
    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid
    log-error=/opt/bitnami/mysql/logs/mysqld.log
    character-set-server=UTF8
    collation-server=utf8_general_ci
    {% if flavourConfig.binlog.enabled %}
    {% for key,value in flavourConfig.binlog.configuration.items() %}
    {{ key }}={{ value }}
    {% endfor %}
    {% endif %}
    [client]
    port=3306
    socket=/opt/bitnami/mysql/tmp/mysql.sock
    default-character-set=UTF8
    plugin_dir=/opt/bitnami/mysql/lib/plugin
    [manager]
    port=3306
    socket=/opt/bitnami/mysql/tmp/mysql.sock
    pid-file=/opt/bitnami/mysql/tmp/mysqld.pid

secondary: 
  resources:
    requests:
      memory: {{ flavourConfig.reader.resources.requests.memory }}
      cpu: {{ flavourConfig.reader.resources.requests.cpu }}
      ephemeral-storage: {{ flavourConfig.reader.resources.requests.ephemeralStorage }}
    limits:
      memory: {{ flavourConfig.reader.resources.limits.memory }}
      cpu: {{ flavourConfig.reader.resources.limits.cpu }}
      ephemeral-storage: {{ flavourConfig.reader.resources.limits.ephemeralStorage }}
    
    {% if flavourConfig.reader.tolerations %}
    tolerations:
      {% for toleration in flavourConfig.reader.tolerations %}
      - key: {{ toleration.key }}
        operator: {{ toleration.operator }}
        {% if toleration.value %}
        value: {{ toleration.value }}
        {% endif %}
        {% if toleration.effect %}
        effect: {{ toleration.effect }}
        {% endif %}
      {% endfor %}
    {% endif %}

  {% if serviceAnnotations %}
  service:
    annotations:
      {% for key,value in serviceAnnotations.items() %}
      {{ key }}: "{{ value }}"
      {% endfor %}
  {% endif %}

  replicaCount: {{ flavourConfig.reader.replicaCount }}
  {% if flavourConfig.reader.nodeSelector %}
  nodeSelector:
    {% for key, value in flavourConfig.reader.nodeSelector.items() %}
    {{ key }}: {{ value }}
    {% endfor %}
  {% endif %}
  persistence:
    enabled: true
    size: {{ flavourConfig.reader.persistence.size }}
    storageClass: {{ flavourConfig.storageClass }}    

initdbScripts:
  init.sh: |
    #!/bin/bash
    if [[ "${MYSQL_REPLICATION_MODE}" == "master" ]]; then
    mysql -u root -p${MYSQL_ROOT_PASSWORD} << EOF
    GRANT ALL PRIVILEGES ON * . * TO '$MYSQL_USER'@'%';
    FLUSH PRIVILEGES;
    EOF
    fi
